---
- hosts: all
  become: yes
  gather_facts: yes
  vars:
    data_partition: "/data"
    enable_lvm: false
  roles:
    - cloud-node
    - mysql80-init

  tasks:
    - name: Install console tools
      when: ansible_os_family == 'RedHat'
      yum: name={{ item }} state=installed
      with_items:
        - screen
        - wget
        - telnet
        - curl
        - qpress
        - yum-utils
        - cronie
        - policycoreutils
        - policycoreutils-python
        - python-boto
        - python-setuptools
        - python-requests
        - rsync
        - sysstat
        - net-tools
        - lsof
        - vim
        - tmux
        - innotop
        - firewalld
        - firewalld-filesystem

    - name: Install Percona tools
      when: ansible_os_family == 'RedHat'
      yum: name={{ item }} state=installed
      with_items:
        - percona-toolkit
        - percona-xtrabackup-80
        - percona-server-devel

    - name: Update NSS
      when: ansible_os_family == 'RedHat'
      yum: name={{ item }} state=installed
      with_items:
        - nss

    - name: Enable firewall
      shell: cd /tmp; nohup sh -c "systemctl enable firewalld; systemctl restart dbus; systemctl restart firewalld"

    - name: Check firewall
      shell: cd /tmp; nohup sh -c "ps wwaux | grep firewalld"

    - name: Check firewall 2
      shell: cd /tmp; nohup sh -c "systemctl status firewalld"

    - name: Add firewalld rule
      when: ansible_os_family == 'RedHat'
      firewalld: port={{ item }} permanent=true state=enabled immediate=yes
      with_items:
          - 3306/tcp
          - 42000-42010/tcp

    - name: cloud-init                 | Fix start-up sequence
      replace:
        dest: /usr/lib/systemd/system/cloud-final.service
        regexp: 'After='
        replace: 'After=mysqld.service '

    - name: PMM                        | Fix SSH MACs
      shell: cd /tmp; nohup sh -c "echo 'MACs                                       hmac-sha2-256,hmac-sha2-512' >> /etc/ssh/sshd_config" 

    - name: PMM                        | Fix SSH Key
      shell: cd /tmp; nohup sh -c "sed -i 's:HostKey /etc/ssh/ssh_host_ecdsa_key:#HostKey /etc/ssh/ssh_host_ecdsa_key:' /etc/ssh/sshd_config"

    - name: PMM                        | Fix SSH Ciphers
      shell: cd /tmp; nohup sh -c "echo 'Ciphers                                    aes128-ctr,aes192-ctr,aes256-ctr' >> /etc/ssh/sshd_config"
 
    - name: PMM                        | Fix SSH Kex
      shell: cd /tmp; nohup sh -c "echo 'KexAlgorithms                              curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256' >> /etc/ssh/sshd_config"

    - name: PMM                        | Restart SSH
      shell: cd /tmp; nohup sh -c "trap 'systemctl restart sshd && sync' EXIT; sleep 60"
 
    - name: PMM                        | Delete centos user
      shell: cd /tmp; nohup sh -c "trap 'userdel -r centos && sync' EXIT; sleep 600" </dev/null >/dev/null 2>&1 &

    - name: PMM                        | Delete Azure user
      shell: cd /tmp; nohup sh -c "trap '/usr/sbin/waagent -force -deprovision+user && sync' EXIT; sleep 600" </dev/null >/dev/null 2>&1 &

